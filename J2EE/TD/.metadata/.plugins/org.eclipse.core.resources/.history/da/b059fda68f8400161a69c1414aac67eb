package projet_tetris;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.sql.Connection;
import java.sql.Statement;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.sql.DataSource;

public class ServletInsertScore extends HttpServlet {
	
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	private DataSource ds;
	Connection BD;
	
protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException{
		
		try{
			ObjectInputStream entree = new ObjectInputStream(request.getInputStream());
			Joueur nouveauJoueur = null;
			//Lecture d'un objet joueur (bestJoueur)
			nouveauJoueur=(Joueur)entree.readObject();
			ObjectOutputStream sortie = new ObjectOutputStream(response.getOutputStream()); 
			BD=ds.getConnection();
			Statement s = BD.createStatement();
			System.out.println("Insertion"+nouveauJoueur.getNom()+" "+nouveauJoueur.getNiveau()+" "+nouveauJoueur.getScore());
			s.executeUpdate("INSERT INTO `score`(`id_joueur`, `nom`, `score`, `niveau`) VALUES (null , '"+nouveauJoueur.getNom()+"' , "+nouveauJoueur.getScore()+", "+nouveauJoueur.getNiveau()+")");
			s.executeUpdate("DELETE FROM score ORDER BY score ASC LIMIT 1");
			sortie.writeObject(null);
		}
		 catch (Exception ex){
		      System.out.println("Erreur d'exécution de la requête SQL (insert) : " + ex);
		 }       
	}
	
	public void init() throws ServletException{
	    try{
	      Context initCtx = new InitialContext();
	      System.out.println("lookup de env");
	      Context envCtx = (Context)initCtx.lookup("java:comp/env");
	      System.out.println("lookup de Tetris");
	      this.ds = ((DataSource)envCtx.lookup("Tetris"));
	    }
	    catch (Exception er){
	      System.out.println("Erreur de chargement du contexte " + er);
	    }
	  }
}
