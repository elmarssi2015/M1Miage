package servlet;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.sql.DataSource;

import sResultSet.SerializedResultSet;

	public class ServletTetris extends HttpServlet {
		Connection BD;
		DataSource ds;
		
		protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
			try {
				BD=ds.getConnection();
				Statement s = BD.createStatement();
				ResultSet r = s.executeQuery("select * from player");
				PrintWriter out=null;
				resp.setContentType("text/html");
				out = resp.getWriter();
				out.println("<html>");
				out.println("<head><title> Test servlet </title></head>");
				out.println("<body>");
				out.println("Contenu de la table personne <BR>");
				out.println("<table>");
				out.println("<TR>");
				out.println("<TD>Nom</TD>");
				out.println("<TD>Prénom</TD>");
				out.println("</TR>");
				while (r.next()) {
					out.println("<TR>");
					out.println("<TD>");
					out.println(r.getString("nom"));
					out.println("</TD>");
					out.println("<TD>");
					out.println(r.getString("score"));
					out.println("</TD>");
					out.println("</TR>");
					}
				out.println("</table>");
				out.println("</body>");
				out.println("</html>");
				r.close();
				s.close();
				BD.close();
				s = null;
				r = null;
			} catch (java.sql.SQLException ex) {
				System.out.println("Erreur d'exécution de la requête SQL \n"+ex);
			}
		}

		@Override
		public void init() throws ServletException {
			try {
				System.out.println("Récupération du contexte");
				Context initCtx = new InitialContext();
				System.out.println("lookup de env");
				Context envCtx = (Context) initCtx.lookup("java:comp/env");
				System.out.println("lookup de Tetris");
				ds=(DataSource) envCtx.lookup("Tetris");
				System.out.println("Datasource chargée");
				}
				catch(Exception er) {
					System.out.println("Erreur de chargement du contexte " + er);
				}
		}
	}